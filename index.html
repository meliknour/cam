<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تسجيل الدخول / إنشاء حساب</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #f0f2f5;
      --card: #fff;
      --primary: #3a3b57;
      --text: #111;
      --error: #d93025;
      --success: #188038;
      --transition: all 0.3s ease;
    }
    body.dark { --bg:#18191a; --card:#242526; --primary:#9aa0a6; --text:#e4e6eb; }
    body { font-family:'Segoe UI',Tahoma,Arial,sans-serif; background:var(--bg); margin:0; display:flex; justify-content:center; align-items:center; min-height:100vh; transition:var(--transition); padding:20px; }
    .card { background:var(--card); padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:100%; max-width:420px; min-height:400px; transition:var(--transition); position:relative; overflow:visible; display:flex; flex-direction:column; }
    body.dark .card { box-shadow:0 4px 15px rgba(0,0,0,0.3); }
    h2 { margin:0 0 20px; color:var(--primary); text-align:center; transition:var(--transition); }
    .form-container { position:relative; flex:1; overflow:visible; min-height:380px; }
    .form { position:absolute; width:100%; transition:all 0.4s cubic-bezier(0.68,-0.55,0.27,1.55); }
    #loginForm { left:0; opacity:1; transform:translateX(0); }
    #registerForm { left:0; opacity:0; transform:translateX(100%); }
    .show-register #loginForm { opacity:0; transform:translateX(-100%); }
    .show-register #registerForm { opacity:1; transform:translateX(0); }
    .input-group { margin-bottom:18px; position:relative; }
    input { width:90%; padding:12px 40px 12px 12px; border:1px solid #ccc; border-radius:8px; background:transparent; color:var(--text); font-size:15px; transition:var(--transition); }
    body.dark input { border-color:#4e4f50; }
    input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(58,59,87,0.2); }
    .toggle-password { position:absolute; left:12px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:16px; color:#777; background:none; border:none; width:24px; height:24px; display:flex; align-items:center; justify-content:center; }
    body.dark .toggle-password { color:#b0b3b8; }
    button.submit-btn { width:100%; padding:12px; border:none; border-radius:8px; background:var(--primary); color:#fff; font-weight:bold; cursor:pointer; transition:var(--transition); margin-top:5px; }
    button.submit-btn:hover { opacity:0.9; transform:translateY(-2px); }
    .switch { margin-top:15px; text-align:center; font-size:14px; color:#65676b; }
    .switch span { color:var(--primary); cursor:pointer; font-weight:600; transition:var(--transition); }
    .switch span:hover { text-decoration:underline; }
    .toggle-mode { text-align:center; margin-top:20px; font-size:14px; cursor:pointer; color:var(--primary); display:flex; align-items:center; justify-content:center; gap:8px; transition:var(--transition); }
    .toggle-mode:hover { opacity:0.8; }
    .forgot { text-align:left; font-size:13px; margin-top:-10px; margin-bottom:15px; }
    .forgot span { color:var(--primary); cursor:pointer; transition:var(--transition); }
    .forgot span:hover { text-decoration:underline; }
    .password-rules { font-size:12px; margin-top:-5px; margin-bottom:15px; line-height:1.6; max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
    .password-rules.show { max-height:100px; }
    .rule { display:flex; align-items:center; gap:6px; margin-bottom:4px; }
    .rule i { font-size:10px; transition:var(--transition); }
    .rule.valid { color:var(--success); }
    .rule.invalid { color:var(--error); }
    .message { padding:10px; border-radius:6px; margin-bottom:15px; text-align:center; display:none; font-size:14px; transition:var(--transition); }
    .error { background-color: rgba(217,48,37,0.1); color:var(--error); border:1px solid rgba(217,48,37,0.2); }
    .success { background-color: rgba(24,128,56,0.1); color:var(--success); border:1px solid rgba(24,128,56,0.2); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation:fadeIn 0.5s ease forwards; }
  </style>
</head>
<body>
  <div class="card">
    <div class="form-container" id="formContainer">
      <!-- Login Form -->
      <div class="form" id="loginForm">
        <h2>تسجيل الدخول</h2>
        <div class="message error" id="loginMessage"></div>
        <div class="input-group">
          <input type="email" id="loginEmail" placeholder="البريد الإلكتروني" required>
        </div>
        <div class="input-group">
          <input type="password" id="loginPassword" placeholder="كلمة المرور" required>
          <button type="button" class="toggle-password" onclick="togglePassword('loginPassword', this)">
            <i class="far fa-eye"></i>
          </button>
        </div>
        <div class="forgot"><span onclick="resetPassword()">نسيت كلمة المرور؟</span></div>
        <button class="submit-btn" onclick="login()">تسجيل الدخول</button>
        <div class="switch">ليس لديك حساب؟ <span onclick="showRegister()">إنشاء حساب</span></div>
      </div>

      <!-- Register Form -->
      <div class="form" id="registerForm">
        <h2>إنشاء حساب</h2>
        <div class="message error" id="registerMessage"></div>
        <div class="input-group">
          <input type="text" id="registerName" placeholder="الاسم الكامل" required>
        </div>
        <div class="input-group">
          <input type="email" id="registerEmail" placeholder="البريد الإلكتروني" required>
        </div>
        <div class="input-group">
          <input type="password" id="registerPassword" placeholder="كلمة المرور" required oninput="checkPassword(this.value)">
          <button type="button" class="toggle-password" onclick="togglePassword('registerPassword', this)">
            <i class="far fa-eye"></i>
          </button>
        </div>
        <div id="passwordRules" class="password-rules">
          <div class="rule invalid" id="lengthRule"><i class="fas fa-circle"></i> <span>8 أحرف على الأقل</span></div>
          <div class="rule invalid" id="upperRule"><i class="fas fa-circle"></i> <span>حرف كبير واحد على الأقل</span></div>
          <div class="rule invalid" id="numberRule"><i class="fas fa-circle"></i> <span>رقم واحد على الأقل</span></div>
        </div>
        <button class="submit-btn" onclick="register()" id="registerBtn">إنشاء حساب</button>
        <div class="switch">لديك حساب بالفعل؟ <span onclick="showLogin()">تسجيل الدخول</span></div>
      </div>
    </div>
    <div class="toggle-mode" onclick="toggleMode()">
      <i class="fas fa-moon"></i> تبديل الوضع الليلي
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } 
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, setDoc } 
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBq45NTkOCdirrGjwPqv_kUJ7tibyThJww",
      authDomain: "soft-ff1e8.firebaseapp.com",
      projectId: "soft-ff1e8",
      storageBucket: "soft-ff1e8.appspot.com",
      messagingSenderId: "17443109810",
      appId: "1:17443109810:web:c72598153a7b82ba3042ab",
      measurementId: "G-NR4LP6M583"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginMessage = document.getElementById('loginMessage');
    const registerMessage = document.getElementById('registerMessage');
    const passwordRules = document.getElementById('passwordRules');
    const registerBtn = document.getElementById('registerBtn');
    const toggleModeBtn = document.querySelector('.toggle-mode');
    const formContainer = document.getElementById('formContainer');

    window.showRegister = () => { formContainer.classList.add('show-register'); loginMessage.style.display='none'; }
    window.showLogin = () => { formContainer.classList.remove('show-register'); registerMessage.style.display='none'; }
    window.togglePassword = (id, btn) => {
      const input = document.getElementById(id);
      const icon = btn.querySelector('i');
      if(input.type==="password"){ input.type="text"; icon.classList.replace('fa-eye','fa-eye-slash'); }
      else{ input.type="password"; icon.classList.replace('fa-eye-slash','fa-eye'); }
    }
    window.checkPassword = val => {
      updateRule('lengthRule', val.length>=8);
      updateRule('upperRule', /[A-Z]/.test(val));
      updateRule('numberRule', /[0-9]/.test(val));
      passwordRules.classList.toggle('show', val.length>0);
      registerBtn.disabled = !(val.length>=8 && /[A-Z]/.test(val) && /[0-9]/.test(val));
    }
    function updateRule(id, valid){
      const rule=document.getElementById(id);
      if(valid){ rule.classList.replace('invalid','valid'); rule.querySelector('i').classList.replace('fa-circle','fa-check-circle'); }
      else{ rule.classList.replace('valid','invalid'); rule.querySelector('i').classList.replace('fa-check-circle','fa-circle'); }
    }

    window.login = async () => {
      const email=document.getElementById("loginEmail").value;
      const pass=document.getElementById("loginPassword").value;
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        showMessage(loginMessage,"تم تسجيل الدخول بنجاح","success");
        setTimeout(()=>window.location.href="home.html",1500);
      }catch(e){ showMessage(loginMessage,"خطأ: "+e.message,"error"); }
    }

    window.register = async () => {
      const name=document.getElementById("registerName").value;
      const email=document.getElementById("registerEmail").value;
      const pass=document.getElementById("registerPassword").value;
      if(!(pass.length>=8 && /[A-Z]/.test(pass) && /[0-9]/.test(pass))){
        showMessage(registerMessage,"كلمة المرور لا تستوفي الشروط","error"); return;
      }
      try{
        const userCredential = await createUserWithEmailAndPassword(auth,email,pass);
        const user = userCredential.user;
        if(auth.currentUser){
          await setDoc(doc(db,"users",user.uid),{ name,email,darkMode:document.body.classList.contains("dark") });
          showMessage(registerMessage,"تم إنشاء الحساب بنجاح","success");
          setTimeout(()=>showLogin(),1500);
        }else{
          showMessage(registerMessage,"حدث خطأ أثناء تسجيل الدخول تلقائياً","error");
        }
      }catch(e){ showMessage(registerMessage,"خطأ: "+e.message,"error"); }
    }

    window.resetPassword = async () => {
      const email = prompt("أدخل بريدك الإلكتروني لإعادة تعيين كلمة المرور:");
      if(email){
        try{ await sendPasswordResetEmail(auth,email); alert("تم إرسال رابط إعادة التعيين"); }
        catch(e){ alert("خطأ: "+e.message); }
      }
    }

    window.toggleMode = () => {
      document.body.classList.toggle("dark");
      if(document.body.classList.contains("dark")){
        toggleModeBtn.innerHTML='<i class="fas fa-sun"></i> تبديل الوضع النهاري';
      }else{
        toggleModeBtn.innerHTML='<i class="fas fa-moon"></i> تبديل الوضع الليلي';
      }
    }

    function showMessage(element,text,type){
      element.textContent=text;
      element.className=`message ${type} fade-in`;
      element.style.display='block';
      setTimeout(()=>{ element.style.display='none'; },5000);
    }
  </script>
</body>
</html>
