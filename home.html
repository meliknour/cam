<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, updateDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBq45NTkOCdirrGjwPqv_kUJ7tibyThJww",
    authDomain: "soft-ff1e8.firebaseapp.com",
    projectId: "soft-ff1e8",
    storageBucket: "soft-ff1e8.appspot.com",
    messagingSenderId: "17443109810",
    appId: "1:17443109810:web:7dd2c4dbb462f4c502b9f3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // تحقق من تسجيل الدخول
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html"; 
      return;
    }

    // جلب الوضع من جدول المستخدم
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const darkMode = userSnap.data().darkMode;
      if (darkMode) {
        document.body.classList.add("dark");
      } else {
        document.body.classList.remove("dark");
      }
    }
  });

  // تسجيل الخروج
  function logout() {
    signOut(auth).then(() => {
      window.location.href = "index.html";
    });
  }
  window.logout = logout;

  // تبديل الوضع
  async function toggleDarkMode() {
    const user = auth.currentUser;
    if (!user) return;

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    let newMode = true;
    if (userSnap.exists()) {
      newMode = !userSnap.data().darkMode;
    }

    // تحديث في قاعدة البيانات
    await updateDoc(userRef, { darkMode: newMode });

    // تحديث المظهر مباشرة
    if (newMode) {
      document.body.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
    }
  }
  window.toggleDarkMode = toggleDarkMode;

  // إظهار/إخفاء القائمة المنبثقة
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsMenu = document.getElementById("settingsMenu");

  settingsBtn.addEventListener("click", (e) => {
    e.preventDefault();
    settingsMenu.classList.toggle("show");
  });

  // إخفاء القائمة عند الضغط خارجها
  window.addEventListener("click", (e) => {
    if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
      settingsMenu.classList.remove("show");
    }
  });
</script>
